---
title: RunLoop 学习笔记
date: 2017-01-04 21:18:46
tags: [RunLoop]
---

RunLoop 是 iOS 开发当中一个很基础又很重要的概念。由于它是一个很底层的概念，日常开发中很少直接接触到，再加上官方文档写得很难理解，导致很多开发者（包括我自己）都对这个概念一知半解。但是，既然它是很重要的概念，又是 iOS 开发的底层基础，我们就不得不去把它啃下来。

同时，RunLoop 与 RunTime 作为 iOS 开发当中的两个面试加分利器，更增加了我们去掌握它的必要性。

经过这几天的学习，感觉自己对 RunLoop 的概念（只是概念，而非应用）理解得比较清晰了，因此写篇笔记来帮助自己梳理思路。

## 为何要有 RunLoop

理解 RunLoop 的首要前提就是要明白它为何会存在，它存在的目的是什么。

相信大家都学过 C 语言，C 语言当中最简单的程序就是 Hello World 了。整个程序就只打印出一句 Hello World，然后立马结束运行。这也是大多数命令行程序的运行方法，一次执行一个任务，执行完后就退出。

但是一个 iOS 应用一旦启动起来后就会一直处于等待用户事件（类似点击或者触摸事件）的状态，除非用户手动关闭它，不然它是不会退出的。那它是怎么做到的呢，这就是 RunLoop 起到的作用了。

RunLoop 是一种事件驱动（Event Driven）模型，这种模型并非是 iOS 特有的。Android 中的 Looper 和 Windows SDK 开发中的消息循环机制都是属于这种模型。

作为一个开发过 Windows SDK 程序的程序员，对那些 WM_ 开头的各种消息都还记忆犹新。Windows 中的消息循环机制也是事件驱动的一种，只是那时需要接收并手动处理各种消息。而 iOS 封装得比较完全，我们不需要直接跟各种消息回调打交道，只需要处理事件就行了，这就是为什么我们平常很少接触到 RunLoop 的原因。

## RunLoop 是何时启动的

既然 RunLoop 可以让应用保持等待接受用户事件的状态，那么它是何时启动的呢。似乎我们在开发中并没有写过任何有关启动 RunLoop 的代码。

答案是，我们并不需要手动写。

当我们使用 Xcode 创建一个新的 iOS 应用时，它会自动帮我们生成一个 main.m 文件，在这个文件里面只有一个 main 方法，而在 main 方法里面会调用 `UIApplicationMain(_:_:_:_:)` 方法。`UIApplicationMain` 会将 AppDelegate 设置为应用程序的代码，同时会为主线程创建一个 RunLoop 并启动。

因此任何一个 iOS 应用一旦启动了，就至少存在一个 RunLoop，并且这个 RunLoop 是属于主线程的。之所以说属于主线程，是因为 RunLoop 与线程的关系是一一对应的，关于这点，在后面会讲到。

